#!/bin/bash

# Ensure the .buildkite directory exists
mkdir -p .buildkite

# Fallback: If pipeline.yml is missing, clone it from a fallback repo
if [ ! -f ".buildkite/pipeline.yml" ]; then
  echo "‚ö†Ô∏è  .buildkite/pipeline.yml not found"
  echo "üì• Cloning fallback buildkite config from $BUILDKITE_FOLDER_GIT_REPO_PATH ..."

  # Clone only the latest commit
  git clone --depth=1 "$BUILDKITE_FOLDER_GIT_REPO_PATH" /tmp/buildkite-temp || {
    echo "‚ùå Failed to clone fallback repo!"
    exit 1
  }

  # Copy contents if .buildkite exists in the fallback repo
  if [ -d /tmp/buildkite-temp/.buildkite ]; then
    cp -r /tmp/buildkite-temp/.buildkite/* .buildkite/
    echo "‚úÖ .buildkite contents restored from fallback repo"
  else
    echo "‚ùå .buildkite folder not found in fallback repo"
    exit 1
  fi

  # Clean up
  rm -rf /tmp/buildkite-temp
fi
