# GitLab CI configuration for Dagster Cloud Serverless
# Generated by: dg scaffold gitlab-ci
#
# For more information, see: https://docs.dagster.io/dagster-plus/deployment

workflow:
  rules:
    # Run on merge requests
    - if: $CI_MERGE_REQUEST_IID
    # Run on default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on main/master branch
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

variables:
  # The organization name in Dagster Cloud
  DAGSTER_CLOUD_ORGANIZATION: "TEMPLATE_ORGANIZATION_NAME"

  # Path to the root folder containing the dagster project
  DAGSTER_PROJECT_DIR: "TEMPLATE_PROJECT_DIR"

  # Path to the dagster_cloud.yaml file
  DAGSTER_CLOUD_FILE: "dagster_cloud.yaml"

  # Python version to use for PEX builds
  PYTHON_VERSION: "3.10"

  # Enable fast deploys using PEX
  ENABLE_FAST_DEPLOYS: "true"

  # Default deployment name for full deployments
  DEFAULT_DEPLOYMENT_NAME: "TEMPLATE_DEFAULT_DEPLOYMENT_NAME"

stages:
  - deploy

dagster-cloud-deploy:
  stage: deploy
  image: python:3.10
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    # Install required tools
    - apt-get update && apt-get install -y curl jq
    # Install dg CLI
    - pip install dagster-cloud-cli
    # Detect deployment type (branch vs full)
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        export DEPLOYMENT_TYPE="branch"
        export DEPLOYMENT_NAME="$DEFAULT_DEPLOYMENT_NAME"
      else
        export DEPLOYMENT_TYPE="full"
        export DEPLOYMENT_NAME="$DEFAULT_DEPLOYMENT_NAME"
      fi
  script:
    # Initialize the deployment
    - cd $DAGSTER_PROJECT_DIR
    - |
      dg-cloud deployment deploy \
        --deployment $DEPLOYMENT_NAME \
        --project-dir $DAGSTER_PROJECT_DIR \
        --agent-type serverless \
        --python-version $PYTHON_VERSION
  after_script:
    # Update merge request comment with deployment status
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        dg-cloud ci notify --project-dir=$DAGSTER_PROJECT_DIR || true
      fi
  rules:
    # Skip on closed merge requests
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "close"
      when: never
    - when: on_success
