variables:
  # The organization name in Dagster Cloud
  DAGSTER_CLOUD_ORGANIZATION: TEMPLATE_ORGANIZATION_NAME
  # The Dagster Cloud URL
  DAGSTER_CLOUD_URL: TEMPLATE_DAGSTER_CLOUD_URL
  # The API token from https://dagster.cloud/ should be stored in a CI/CD Variable called DAGSTER_CLOUD_API_TOKEN
  DAGSTER_CLOUD_API_TOKEN: $DAGSTER_CLOUD_API_TOKEN
  # Path to the root folder containing the dagster project
  DAGSTER_PROJECT_DIR: TEMPLATE_PROJECT_DIR
  # State directory for deploy session
  DAGSTER_BUILD_STATEDIR: /tmp/dagster-build-state-$CI_PIPELINE_ID
  # Required for Docker-in-Docker
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

stages:
  - deploy

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

dagster-cloud-serverless-deploy:
  stage: deploy
  image: python:3.12
  services:
    - docker:dind
  interruptible: true
  before_script:
    # Install Docker CLI and uv
    - apt-get update && apt-get install -y docker.io
    - pip install uv
  script:
    - cd $DAGSTER_PROJECT_DIR

    # Sync all projects (workspace or single project)
    - |
      for project in $(python -m uv run dg list projects); do
        (cd "$project" && python -m uv sync)
      done

    # Initialize build session
    - >
      python -m uv run dg plus deploy start
      --deployment=TEMPLATE_DEFAULT_DEPLOYMENT_NAME
      --yes

    # Refresh state for any StateBackedComponents in the project
    - python -m uv run dg plus deploy refresh-defs-state

    # Ensure .venv is excluded from Docker builds
    - echo ".venv" >> .dockerignore

    # Build and push (PEX or Docker based on project configuration)
    - python -m uv run dg plus deploy build-and-push --agent-type=serverless

    # Deploy all code locations in this build session to Dagster Cloud
    - python -m uv run dg plus deploy finish
  after_script:
    # Generate a summary - this runs always() so the summary is generated on success and failure
    - pip install uv 2>/dev/null || true
    - cd $DAGSTER_PROJECT_DIR
    - python -m uv run dagster-cloud ci status --output-format=markdown || true
