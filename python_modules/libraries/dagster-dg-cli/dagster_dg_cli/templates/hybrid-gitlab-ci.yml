# GitLab CI configuration for Dagster Cloud Hybrid
# Generated by: dg scaffold gitlab-ci
#
# For more information, see: https://docs.dagster.io/dagster-plus/deployment

workflow:
  rules:
    # Run on merge requests
    - if: $CI_MERGE_REQUEST_IID
    # Run on default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on main/master branch
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

variables:
  # The organization name in Dagster Cloud
  DAGSTER_CLOUD_ORGANIZATION: "TEMPLATE_ORGANIZATION_NAME"

  # Path to the root folder containing the dagster project
  DAGSTER_PROJECT_DIR: "TEMPLATE_PROJECT_DIR"

  # Path to the dagster_cloud.yaml file
  DAGSTER_CLOUD_FILE: "dagster_cloud.yaml"

  # Default deployment name for full deployments
  DEFAULT_DEPLOYMENT_NAME: "TEMPLATE_DEFAULT_DEPLOYMENT_NAME"

  # Docker image tag - using GitLab CI variables for uniqueness
  IMAGE_TAG: "${CI_COMMIT_SHA}-${CI_PIPELINE_ID}-${CI_PIPELINE_IID}"

stages:
  - build
  - deploy

# Initialize the deployment session
init-deployment:
  stage: .pre
  image: python:3.10
  before_script:
    - pip install dagster-cloud-cli
  script:
    - cd $DAGSTER_PROJECT_DIR
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        export DEPLOYMENT_NAME="$DEFAULT_DEPLOYMENT_NAME"
      else
        export DEPLOYMENT_NAME="$DEFAULT_DEPLOYMENT_NAME"
      fi
    - dg plus deploy init --deployment $DEPLOYMENT_NAME --path $DAGSTER_PROJECT_DIR
  rules:
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "close"
      when: never
    - when: on_success

# TEMPLATE_BUILD_LOCATION_FRAGMENT

# Deploy all code locations to Dagster Cloud
deploy-to-dagster-cloud:
  stage: deploy
  image: python:3.10
  before_script:
    - pip install dagster-cloud-cli
  script:
    - cd $DAGSTER_PROJECT_DIR
    - dg plus deploy finish --path $DAGSTER_PROJECT_DIR
  after_script:
    # Update merge request comment with deployment status
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        dg-cloud ci notify --project-dir=$DAGSTER_PROJECT_DIR || true
      fi
  rules:
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "close"
      when: never
    - when: on_success
