# ########################
# ##### PYRIGHT
# ########################

# [Docs root]
#   https://github.com/microsoft/pyright/tree/main/docs
# [Config option reference]
#   https://github.com/microsoft/pyright/blob/main/docs/configuration.md

# Pyright does not have a docs site, but the documentation (a collection of
# markdown files in the GH repo, linked above) is pretty thorough.

[tool.pyright]

typeCheckingMode = "standard"

include = [
  "docs/sphinx/_ext/dagster-sphinx",
  "python_modules",
  "examples",
  "integration_tests",
  "scripts",
]

# Unfortunately pyright does not offer a way to extend the default exclusions, so we have to
# reiterate them here if we want to add anything else.
exclude = [
  "**/node_modules",
  "**/__pycache__",
  "**/__generated__",
  "**/vendor",
  "**/_vendored",
  "**/.tox",
  ".git",
  "**/.venv*",
  "**/build",
]

extraPaths = [
  ".buildkite/buildkite-shared"
]

# These two settings point pyright to a python environment to resolve imports against. This virtual
# environment is defined in the `pyright` tox environment in the tox section below-- that
# environment must be built before pyright can run correctly.
venv = ".venv"
venvPath = "pyright/master"


# Minimum version of Python on which code must run. This determines the standard library stubs used by
# pyright.
pythonVersion = "3.10"


# Disable reading type annotations from libraries that are not explicitly marked as typed (i.e. that
# include a py.typed file). All imports from these libraries are given the `Unknown` type (i.e.
# `Any`). This setting does not affect `py.typed` libraries.
useLibraryCodeForTypes = false

# We use ruff for this.
reportInvalidStringEscapeSequence = false

# As of 2023-02-02, there are still many `py.typed` libs that are not compliant with the standards
# for defining a public API.
reportPrivateImportUsage = false

# Since we only use pyright, there is no need to suppress type errors that pyright does not
# recognize.
reportUnnecessaryTypeIgnoreComment = "warning"

# Skip analyzing unannotated code in examples to facilitate terse code.
executionEnvironments = [
  { root = "examples", analyzeUnannotatedFunctions=false },
  { root = "python_modules" },
  { root = "integration_tests" }
]

# ########################
# ##### PYTEST
# ########################

[tool.pytest.ini_options]

filterwarnings = [
  "ignore::DeprecationWarning",
  "ignore::UserWarning",
  "ignore::pytest.PytestCollectionWarning",
]

markers = [
  "unit: Fast unit tests with no external dependencies",
  "integration: Tests requiring real git operations or other I/O",
  "e2e: End-to-end tests requiring GitHub authentication",
  "slow: Tests that take more than 1 second",
]

timeout = 240
addopts = "-ra"

# ########################
# ##### RUFF
# ########################
#
# The canonical ruff configuration is in ./config/ruff.toml. This file extends it with
# OSS-specific settings (excludes, per-file-ignores).

[tool.ruff]
extend = "./config/ruff.toml"

# *.py, *.ipy are included by default
extend-include = ["*.ipynb"]

extend-exclude = [
  "*/__generated__/*",
  "*/dagster_airflow/vendor/*",
  "*/_vendored/*",
  "*/snapshots/*",
  "python_modules/libraries/dagstermill/dagstermill_tests/notebooks/cli_test_scaffold.ipynb",
]

[tool.ruff.lint]

# we only want to format notebooks, not lint them
exclude = ["*.ipynb"]

[tool.ruff.lint.per-file-ignores]

# Don't format docstrings in alembic migrations.
"**/alembic/versions/*.py" = ["D"]
"examples/docs_snippets/docs_snippets/guides/etl/transform-dbt/dbt_definitions*.py" = ["I001"]

# Modules where it is expected for there to be no __init.py__
"**/*test*/**/" = ["INP001"]
"**/setup.py" = ["INP001"]
"**/conftest.py" = ["INP001"]
"examples/**" = ["INP001"]
"docs/**" = ["INP001"]
"**/scripts/**" = ["INP001"]
"python_modules/dagster/dagster/_core/storage/alembic/env.py" = ["INP001"]
"python_modules/libraries/dagster-airlift/kitchen-sink/**" = ["INP001"]
# There is an __init__.py.tmpl
"python_modules/dagster/dagster/_generate/templates/REPO_NAME_PLACEHOLDER/REPO_NAME_PLACEHOLDER/assets.py" = ["INP001"]

[tool.ruff.format]
exclude = ["examples/docs_snippets/docs_snippets/guides/etl/transform-dbt/dbt_definitions*.py"]

[tool.dagster]
module_name = "dagster_test.toys.repo"

[dependency-groups]
dev = [
    "erk>=0.6.0",
]

[tool.codespell]
# Ref: https://github.com/codespell-project/codespell#using-a-config-file
skip = '.git*,*.pdf,*.svg,*.css,*.min.*,*.umd.js,*.inv,*.csv,*.sql,*.lock,package-lock.json,.yarn,*.ipynb,.cache,.npm,*/_vendored/*,__snapshots__,pyright/,*manifest.json,*/fonts/Global*'
check-hidden = true
# Ignore camelCase/PascalCase identifiers and embedded base64 images in notebooks
ignore-regex = '^\s*"image/\S+": ".*|\b[a-z]+[A-Z]\w*\b|\b[A-Z][a-z]+[A-Z]\w*\b'
# aks/AKS - Azure Kubernetes Service
# ser - serializer abbreviation
# ags - AssetGraphSubset variable
# nd - 2nd abbreviation
# fo - abbreviation
# connexion - Python library name
# failer - class name (thing that fails)
# noo/noes - intentional in test exception messages
# doesnot - used as test asset key path component
# arameters - intentional typo in YAML validation tests
# datas - appears in test fixture file paths
# astroid - Python AST analysis library
# lacker - appears in sample data
# coo - abbreviation
# welp - colloquial English in comment
# parms/parm - used in external API references
# serie - chart data series variable (singular)
# noes - intentional ("Oh noes!") in test
# ue - partial word in test autocomplete fixtures
# blocs - valid word (sections/blocks)
# busses - intentional in Vale style guide (maps to "buses")
# implementors - valid English variant
# unparseable - used in codebase as variable/comment term
# re-use, re-used, re-using, re-usable, re-declare - acceptable hyphenated English
# alpha-numeric - acceptable hyphenated English
# seve - truncated "seven" in test fixture display
# abd - asset key names in test data
# efine - part of "[r]efine" UI text
# custome - truncated "customer" in table display
# nin - dbt jinja filter name in sample manifests
ignore-words-list = 'aks,ser,ags,nd,fo,connexion,failer,noo,doesnot,arameters,datas,astroid,lacker,coo,welp,parms,parm,serie,noes,ue,blocs,busses,implementors,unparseable,re-use,re-used,re-using,re-usable,re-declare,alpha-numeric,seve,abd,efine,custome,nin'
