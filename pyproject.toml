# ########################
# ##### PYRIGHT
# ########################

# [Docs root]
#   https://github.com/microsoft/pyright/tree/main/docs
# [Config option reference]
#   https://github.com/microsoft/pyright/blob/main/docs/configuration.md

# Pyright does not have a docs site, but the documentation (a collection of
# markdown files in the GH repo, linked above) is pretty thorough.

[tool.pyright]

typeCheckingMode = "standard"

include = [
  "docs/sphinx/_ext/dagster-sphinx",
  "python_modules",
  "examples",
  "integration_tests",
  "scripts",
]

# Unfortunately pyright does not offer a way to extend the default exclusions, so we have to
# reiterate them here if we want to add anything else.
exclude = [
  "**/node_modules",
  "**/__pycache__",
  "**/__generated__",
  "**/vendor",
  "**/_vendored",
  "**/.tox",
  ".git",
  "**/.venv*",
  "**/build",
]

extraPaths = [
  ".buildkite/buildkite-shared"
]

# These two settings point pyright to a python environment to resolve imports against. This virtual
# environment is defined in the `pyright` tox environment in the tox section below-- that
# environment must be built before pyright can run correctly.
venv = ".venv"
venvPath = "pyright/master"


# Minimum version of Python on which code must run. This determines the standard library stubs used by
# pyright.
pythonVersion = "3.10"


# Disable reading type annotations from libraries that are not explicitly marked as typed (i.e. that
# include a py.typed file). All imports from these libraries are given the `Unknown` type (i.e.
# `Any`). This setting does not affect `py.typed` libraries.
useLibraryCodeForTypes = false

# We use ruff for this.
reportInvalidStringEscapeSequence = false

# As of 2023-02-02, there are still many `py.typed` libs that are not compliant with the standards
# for defining a public API.
reportPrivateImportUsage = false

# Since we only use pyright, there is no need to suppress type errors that pyright does not
# recognize.
reportUnnecessaryTypeIgnoreComment = "warning"

# Skip analyzing unannotated code in examples to facilitate terse code.
executionEnvironments = [
  { root = "examples", analyzeUnannotatedFunctions=false },
  { root = "python_modules" },
  { root = "integration_tests" }
]

# ########################
# ##### PYTEST
# ########################

[tool.pytest.ini_options]

filterwarnings = [
  "ignore::DeprecationWarning",
  "ignore::UserWarning",
  "ignore::pytest.PytestCollectionWarning",
]

markers = [
  "unit: Fast unit tests with no external dependencies",
  "integration: Tests requiring real git operations or other I/O",
  "e2e: End-to-end tests requiring GitHub authentication",
  "slow: Tests that take more than 1 second",
]

timeout = 240
addopts = "-ra"

# ########################
# ##### RUFF
# ########################
#
# The canonical ruff configuration is in ./config/ruff.toml. This file extends it with
# OSS-specific settings (excludes, per-file-ignores).

[tool.ruff]
extend = "./config/ruff.toml"

# *.py, *.ipy are included by default
extend-include = ["*.ipynb"]

extend-exclude = [
  "*/__generated__/*",
  "*/dagster_airflow/vendor/*",
  "*/_vendored/*",
  "*/snapshots/*",
  "python_modules/libraries/dagstermill/dagstermill_tests/notebooks/cli_test_scaffold.ipynb",
]

[tool.ruff.lint]

# we only want to format notebooks, not lint them
exclude = ["*.ipynb"]

[tool.ruff.lint.per-file-ignores]

# Don't format docstrings in alembic migrations.
"**/alembic/versions/*.py" = ["D"]
"examples/docs_snippets/docs_snippets/guides/etl/transform-dbt/dbt_definitions*.py" = ["I001"]

# Modules where it is expected for there to be no __init.py__
"**/*test*/**/" = ["INP001"]
"**/setup.py" = ["INP001"]
"**/conftest.py" = ["INP001"]
"examples/**" = ["INP001"]
"docs/**" = ["INP001"]
"**/scripts/**" = ["INP001"]
"python_modules/dagster/dagster/_core/storage/alembic/env.py" = ["INP001"]
"python_modules/libraries/dagster-airlift/kitchen-sink/**" = ["INP001"]
# There is an __init__.py.tmpl
"python_modules/dagster/dagster/_generate/templates/REPO_NAME_PLACEHOLDER/REPO_NAME_PLACEHOLDER/assets.py" = ["INP001"]

# (pyupgrade) Phased rollout of UP007/UP045 (non-pep604-annotation). Remove entries as each
# group is migrated. See: https://github.com/dagster-io/internal/issues/20346
"python_modules/dagster/**" = ["UP045"]
"python_modules/dagster-graphql/**" = ["UP045"]
"python_modules/dagster-webserver/**" = ["UP045"]
"python_modules/dagster-pipes/**" = ["UP045"]
"python_modules/dagster-test/**" = ["UP045"]
"python_modules/dagit/**" = ["UP045"]
"python_modules/automation/**" = ["UP045"]
"python_modules/libraries/**" = ["UP045"]
"{.buildkite,docs,examples,helm,integration_tests,scripts}/**" = ["UP045"]

[tool.ruff.format]
exclude = ["examples/docs_snippets/docs_snippets/guides/etl/transform-dbt/dbt_definitions*.py"]

[tool.dagster]
module_name = "dagster_test.toys.repo"

[dependency-groups]
dev = [
    "erk>=0.6.0",
]
