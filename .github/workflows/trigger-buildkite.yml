name: Trigger Buildkite

on:
  push:
    branches: [Issue-29914]

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Trigger Buildkite build
        run: |
          echo "Triggering Buildkite pipeline..."
          echo "Organization: dagster"
          echo "Pipeline: unit-tests" 
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
          # Debug secrets
          echo "Checking secrets availability..."
          if [ -z "${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}" ]; then
            echo "❌ BUILDKITE_API_ACCESS_TOKEN is not set in GitHub Secrets"
            echo "Please add it in: Repository Settings → Secrets and variables → Actions"
            exit 1
          else
            echo "✅ BUILDKITE_API_ACCESS_TOKEN is available"
          fi
          
          if [ -z "${{ secrets.BUILDKITE_ANALYTICS_TOKEN }}" ]; then
            echo "⚠️  BUILDKITE_ANALYTICS_TOKEN is not set in GitHub Secrets"
          else
            echo "✅ BUILDKITE_ANALYTICS_TOKEN is available"
          fi
          
          # Test API access
          echo "Testing API access..."
          user_response=$(curl -s -H "Authorization: Bearer ${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}" \
            "https://api.buildkite.com/v2/user")
          
          if echo "$user_response" | grep -q "Authentication required"; then
            echo "❌ Invalid API token"
            echo "Response: $user_response"
            exit 1
          else
            echo "✅ API access successful"
            echo "User info: $user_response"
          fi
          
          # Try to trigger the build
          echo "Attempting to trigger build..."
          response=$(curl -s -w "%{http_code}" -o response.json \
            -X POST "https://api.buildkite.com/v2/organizations/dagster/pipelines/unit-tests/builds" \
            -H "Authorization: Bearer ${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "message": "Triggered from GitHub Actions - ${{ github.event.head_commit.message }}"
            }')
          
          echo "HTTP Status Code: $response"
          echo "Response Body:"
          cat response.json
          
          # Check if successful
          if [ "$response" = "201" ] || [ "$response" = "200" ]; then
            echo "✅ Build triggered successfully!"
          else
            echo "❌ Failed to trigger build"
          fi
        env:
          BUILDKITE_ANALYTICS_TOKEN: ${{ secrets.BUILDKITE_ANALYTICS_TOKEN }}
