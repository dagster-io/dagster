name: Buildkite Integration

on:
  push:
    branches: [Issue-31069]

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger Buildkite pipeline
        env:
          BUILDKITE_API_ACCESS_TOKEN: ${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}  # ğŸ›¡ï¸ MUST be set in GitHub Secrets!
          BUILDKITE_ANALYTICS_TOKEN: ${{ secrets.BUILDKITE_ANALYTICS_TOKEN }}    # Optional
        run: |
          echo "ğŸ”§ Starting Buildkite pipeline trigger..."
          echo "Org: dagster"
          echo "Pipeline: unit-tests"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

          # Test API access first
          echo "ğŸŒ Testing API access..."
          test_status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN" \
            "https://api.buildkite.com/v2/user")
          
          if [ "$test_status" != "200" ]; then
            echo "âŒ API access failed (status $test_status)"
            exit 1
          else
            echo "âœ… API token is valid."
          fi

          # Trigger build
          echo "ğŸ“¤ Sending build trigger request..."
          response=$(curl -s -w "%{http_code}" -o response.json \
            -X POST "https://api.buildkite.com/v2/organizations/dagster/pipelines/unit-tests/builds" \
            -H "Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- << EOF
            {
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "message": "Triggered from GitHub Actions - ${{ github.event.head_commit.message }}"
            }
EOF
          )

          echo "ğŸ” Response HTTP Code: $response"
          echo "ğŸ“© Response JSON:"
          cat response.json

          if [ "$response" = "201" ] || [ "$response" = "200" ]; then
            echo "âœ… Build triggered successfully!"
          else
            echo "âš ï¸ Primary trigger failed. Trying fallback webhook..."
            
            if [ -n "${{ secrets.BUILDKITE_WEBHOOK_URL }}" ]; then
              curl -X POST "${{ secrets.BUILDKITE_WEBHOOK_URL }}" \
                -H "Content-Type: application/json" \
                -d "{\"ref\": \"refs/heads/${{ github.ref_name }}\", \"after\": \"${{ github.sha }}\", \"repository\": {\"clone_url\": \"${{ github.server_url }}/${{ github.repository }}.git\"}}"
            else
              echo "âŒ No fallback webhook available. Build failed."
              exit 1
            fi
          fi
