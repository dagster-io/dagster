name: BuildKite Integration

on:
  push:
    branches: [Issue-31069]

jobs:
  trigger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Buildkite build
        env:
          BUILDKITE_API_ACCESS_TOKEN: ${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}
        run: |
          echo "🚀 Triggering Buildkite pipeline..."
          echo "Organization: dagster"
          echo "Pipeline: unit-tests"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

          echo "🔐 Validating API token..."
          curl -s -H "Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN" \
               https://api.buildkite.com/v2/user || {
            echo "❌ API token invalid or unauthorized."
            exit 1
          }
          echo "✅ API token is valid."

          echo "📤 Sending build trigger request..."

          read -r -d '' PAYLOAD <<EOF
          {
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "message": "Triggered from GitHub Actions - ${{ github.event.head_commit.message }}"
          }
EOF

          response=$(curl -s -w "%{http_code}" -o response.json \
            -X POST "https://api.buildkite.com/v2/organizations/dagster/pipelines/unit-tests/builds" \
            -H "Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "🔁 Response HTTP Code: $response"
          echo "📩 Response JSON:"
          cat response.json

          if [ "$response" = "201" ] || [ "$response" = "200" ]; then
            echo "✅ Build triggered successfully!"
          else
            echo "❌ Primary trigger failed."

            if [ -n "${{ secrets.BUILDKITE_WEBHOOK_URL }}" ]; then
              echo "🌐 Trying fallback webhook..."
              curl -X POST "${{ secrets.BUILDKITE_WEBHOOK_URL }}" \
                -H "Content-Type: application/json" \
                -d "{\"ref\": \"refs/heads/${{ github.ref_name }}\", \"after\": \"${{ github.sha }}\", \"repository\": {\"clone_url\": \"${{ github.server_url }}/${{ github.repository }}.git\"}}"
            else
              echo "⚠️ No fallback webhook URL provided."
              exit 1
            fi
          fi
